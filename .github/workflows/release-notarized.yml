name: Release macOS app (notarized)
run-name: notarized release ${{ inputs.tag }}

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Existing Git tag to release (e.g. v0.4.5)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  release:
    runs-on: macos-latest

    steps:
      - name: Checkout tag
        env:
          TAG_NAME: ${{ inputs.tag }}
          REPO: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          git init
          git remote add origin "https://x-access-token:${GH_TOKEN}@github.com/${REPO}.git"
          git fetch --depth=1 origin "refs/tags/${TAG_NAME}"
          git checkout FETCH_HEAD

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Import signing certificate
        env:
          MACOS_CERT_P12: ${{ secrets.MACOS_CERT_P12 }}
          MACOS_CERT_PASSWORD: ${{ secrets.MACOS_CERT_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          set -euo pipefail
          KEYCHAIN="$RUNNER_TEMP/build.keychain-db"

          echo "$MACOS_CERT_P12" | base64 --decode > cert.p12

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN"
          security import cert.p12 -k "$KEYCHAIN" -P "$MACOS_CERT_PASSWORD" -T /usr/bin/codesign
          security list-keychains -d user -s "$KEYCHAIN"

      - name: Build archive
        env:
          TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          ARCHIVE_PATH: ${{ runner.temp }}/NeonVisionEditor.xcarchive
        run: |
          set -euo pipefail
          xcodebuild \
            -project "Neon Vision Editor.xcodeproj" \
            -scheme "Neon Vision Editor" \
            -configuration Release \
            -destination "generic/platform=macOS" \
            -archivePath "$ARCHIVE_PATH" \
            CODE_SIGN_STYLE=Manual \
            DEVELOPMENT_TEAM="$TEAM_ID" \
            CODE_SIGN_IDENTITY="Developer ID Application" \
            archive

      - name: Export app
        env:
          TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          ARCHIVE_PATH: ${{ runner.temp }}/NeonVisionEditor.xcarchive
          EXPORT_PATH: ${{ runner.temp }}/export
        run: |
          set -euo pipefail
          mkdir -p "$EXPORT_PATH"

          cat > export.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <plist version="1.0">
          <dict>
            <key>method</key><string>developer-id</string>
            <key>teamID</key><string>${TEAM_ID}</string>
          </dict>
          </plist>
          EOF

          xcodebuild -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportPath "$EXPORT_PATH" \
            -exportOptionsPlist export.plist

      - name: Notarize
        env:
          EXPORT_PATH: ${{ runner.temp }}/export
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
        run: |
          set -euo pipefail
          APP="$EXPORT_PATH/Neon Vision Editor.app"

          ditto -c -k --keepParent "$APP" submit.zip

          xcrun notarytool submit submit.zip \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_APP_SPECIFIC_PASSWORD" \
            --wait

          xcrun stapler staple "$APP"

      - name: Zip notarized app
        env:
          EXPORT_PATH: ${{ runner.temp }}/export
        run: |
          set -euo pipefail
          ditto -c -k --keepParent "$EXPORT_PATH/Neon Vision Editor.app" Neon.Vision.Editor.app.zip

      - name: Create or Update GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_NAME: ${{ inputs.tag }}
        run: |
          set -euo pipefail

          if gh release view "$TAG_NAME" >/dev/null 2>&1; then
            gh release upload "$TAG_NAME" Neon.Vision.Editor.app.zip --clobber
          else
            gh release create "$TAG_NAME" Neon.Vision.Editor.app.zip \
              --title "Neon Vision Editor $TAG_NAME"
          fi

      - name: Trigger homebrew-tap update
        env:
          GH_TOKEN: ${{ secrets.TAP_BOT_TOKEN }}
          TAG_NAME: ${{ inputs.tag }}
        run: |
          set -euo pipefail
          gh api repos/h3pdesign/homebrew-tap/dispatches \
            -f event_type=notarized_release \
            -f client_payload[tag]="$TAG_NAME"
